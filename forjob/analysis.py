random_udids = """
0371B43D-6E95-43C4-B413-C4040BB9CD39
1EA08BCC-9734-421A-A30D-9DD319369BEE
4493F5FB-79EB-4D07-B1B1-D3BCAEF99D8F
47FF1CF3-2C7D-4F38-971F-FCBA5FE3F178
3F4AE543-B712-4E74-AD36-8D10D15ECC5F
30EF63E7-4E1F-4EFB-A418-0F758967F898
2D4FA773-B873-4C41-9BDA-9E71E3B1EC83
39784f5760e91cb8
3E56130B-0935-42A4-AAE3-1C91C8CE31B8
6934834D-651E-4CB7-BFC0-023377A67BD6
19288A87-0553-4112-9BF7-9FFB3DFD04F8
4DEAAC4A-76CA-4C50-A826-6F71772BBDE3
00D8A58F-140C-4BF6-BB12-CF63BB8D69CD
35ECC3CF-E183-4ADA-8F32-0FE771057DBC
744259B5-6EBD-41F8-907B-800167C02BB1
723F8CE1-854F-4A27-9B41-676489FFC371
4CDB2C08-92C5-4453-8995-8A7CE5A2BDC8
0F13133F-4A0B-45B4-A224-05B8BF136D4E
326716E1-9C11-46C6-9DB5-1485DEFC7E5D
6EB880FD-AF43-43F6-B69A-72AAE1BE3306
53E9204C-F323-44B1-A75E-C3DE437F4F8E
29F5D645-B152-43D5-A8A4-73A8F775611A
23EDA37D-1D0D-44B0-855C-663F2D466538
36BCCFF0-E949-46AB-8158-C6EBD105C3B9
37355F2C-4FB5-48BA-85FC-7EE6FFB93F93
199B66DC-5E82-45EB-B0D3-12CB9843CF49
0815FB92-03C9-4774-B336-2A005353FFB8
644f06622eb130a3
451DE03C-9C7D-49EA-AAF9-DC0BD4078468
63ED8CEC-3F81-4FC0-A3EC-1BF30481E7E9
39F5E340-3412-468F-B754-7E5597DCFC66
6FF50924-C59D-4C26-8325-6D569EF640F4
29680530-D313-4B0E-BC29-DA9342BE539C
2B68312B-A347-4119-A3F4-61BE3778BB53
4C18E9B3-BF5E-4F90-B5AC-F9A498395138
78FB9F0C-35E4-4368-B4C2-2CC5E24CEB9A
380DC763-32E8-4CC2-972F-F33769FE0A21
13006632-DE6A-4A16-8DCA-2DF3EBE668AC
5C3EBA3E-2E80-4901-82BD-EEA5F84BFAF3
57AADCE4-21B7-4A01-9B50-A51B916F21F7
5F2A4BD0-545A-42A7-9AA0-E627A290E018
7FAE92EF-1F39-4FBC-AFCA-B8AE15BA79C3
3540829c059dff0e
3e6675d14060111f
7929F54D-27AD-495D-ADFF-8D5CAC76B822
6776390D-8A38-4C44-B400-E80CB0ECC983
21CD9B69-B64F-458A-B101-4DB453CBD846
2945CC8F-C61A-4986-9C66-1EA0F78E825C
64C036B1-09D1-4FC9-90B6-52CCBB717E80
13823497-6294-4C6A-99FF-8A290B9871D6
50424306-0AD2-4486-9A52-9DFAC4124D40
52113234-0066-423D-A11B-A4EF00AA72F4
4FD42EFB-1D58-4443-A959-766D946F8074
368D42DF-2DB8-41D2-990E-60FAD7E5896C
18BA9CA6-9A34-4297-9457-1BC9C61B7585
2201EB4B-94BB-491E-9E7A-95DED8B09DC4
1308e906c380f563
75808C00-11E7-4C64-8CA7-226483DC7FAB
4DE10FB4-16FE-4B40-BAF1-A11B608845CF
35DB9787-DCBA-467A-BCF5-DFA9B3CECCF5
"""
eval_udids = """
001E0EBD-9770-41DC-A883-1DDFA1720BEC
0026F9A9-F923-4BF7-945A-FD5B55147738
02452BB1-BFD7-4A17-848D-0C3B31D13111
02E57B8B-EFFD-457E-A264-42307AD240EE
030E5ABC-5D8B-485C-9B6D-08DBD048E356
04237086-4055-4607-9C67-37264B3964DE
08dfd3a63bf6edb8
09F7B217-B68C-472D-B152-EE0776DE8ABE
0AAF4B98-3231-4B6F-AB8B-5C614F9B36F9
0DBED0FD-89E8-4D5B-8FE1-2BC06FD5BE23
0F5B9CEE-8201-4104-89CC-E001B7810369
140fe1da9e35090e36e
14FB9AD6-9524-4EC1-9622-C08A82B77A03
15C25D8C-CF2A-4B7E-9F9C-F731FFBE7ED1
17812B91-6A27-45E1-999E-7D38D8CAD4C7
1867D23E-E699-4D7C-B214-D340E8DFCD54
1AE822F0-8DA1-40A5-B2A9-CFDD6F33FEB2
1F142ED1-A741-4134-BAA6-53EB9C5242A9
21cf4775886f0d12
25533122-4C0D-4296-8F2F-74E2F4ABBC3D
25d5c977d3aea7d6
25EC53D0-30FC-4621-8572-7D9753F5B4DE
2632EC76-72EA-450A-BC98-A786253DC174
27C6E607-C798-4347-A4F6-B4A323AC4334
27EC7E7E-24AD-4F93-A098-91CD90B0C693
2A8A3839-7C9D-4E08-9189-77F16A419CE5
2BB6A7E5-7910-4415-8E4C-A45F4F756F95
2D0812E0-D72A-480C-AA2D-5D1D3E825595
2D357636-CDFF-46F6-82C4-FBB346D2A176
2DA37648-D7D5-4C65-91D8-0BFCD77208A6
2dcb58d0d58ae173
2EFA6BB6-343B-4FA7-9E3E-7AACDECA63C4
2FA7585A-0688-4D16-B0F6-3D9F50E38BB9
30F6F824-E338-4C65-9E2A-F856BC9E2259
32E6AEF9-E11E-4157-8B2D-B7653BDDE6B2
355569090743886
37519D13-B6CF-4826-96DF-01371B966B42
37553CF3-345B-489C-BF35-A224AF6E8318
39B7C7AB-BF65-469A-BD3E-C43E6709F73B
3B67BAD5-C2FC-4F8B-9B89-6E22E72A2E80
3FC52285-F2B7-4EDA-A62C-CC5A1618B23C
42974001-A26B-4FCD-97F1-D845B0715BCC
45C6433A-5C93-499A-8CA5-EF1483636CFC
49026827-EFFE-41AE-BCEC-4EC2710E459C
4CF88FC2-5442-46B0-9E33-55622C73C564
4F294891-491A-4707-AE49-3563FDD50B0C
52e1981014856146
55EA11CE-8D95-47D1-9B72-CA3DB23F5F31
56563571-B8E4-43AC-99B4-2CBE95969F89
598AF604-A821-4752-9877-DDFBB0826AB2
5ADDE15B-3F50-4EFB-9933-81CF547E4FB1
5B5BE58B-CB6A-49BE-8066-E74A76BE011C
5C60680A-F903-4D56-B4BD-5146B6C92D8A
60BAA0A9-C067-4E9A-82AE-7987AD826DDF
621B5014-5BC1-4233-9DF0-DF742B8D77DE
624bd2cdce71cb5d
651EB6F1-A5DE-4D2C-94E0-960037A1B8F5
690D343F-6F49-45DC-A602-259084B94695
69C5C798-5894-4783-BFBE-27C5FBDC7E86
6E63E7CF-950E-42AF-89AF-1D7DBAF77616
6E84478A-F904-4F92-8127-F0BD90942D0F
6EC7972B-F211-4828-85C0-87031E17F4B3
6EF22146-A437-476D-A96D-1B58739B48E5
6FFFDDEF-59D3-4E37-807E-84A2FE3E17EE
7096F788-221E-43F1-B263-9EAFD10F755B
73809AB7-F28E-498A-822B-232CCB0475DC
75EAFA4A-E2A7-4718-89C2-F87C2A8069C6
7910DA0E-8CF5-467C-AEF5-06D734BC788E
79114DFF-DE95-4ECF-B639-683BDC2097C1
7961BA21-04B0-49F3-8F74-50AFEB6EBB18
798514D7-8B55-4A6F-A776-1CA94CCAF7B8
7C2E64E8-E607-471A-89FC-B7394C167351
7D71FB54-8EE1-49AA-8375-10AAA4B43262
7DD38B79-C3DB-450C-AA72-56E8C23FA6EB
8251B93A-474B-40C7-BE5B-1A7EAF3658CF
842C19AB-D879-434B-B841-F9851C14CBDC
8544027C-99E1-4CB3-B1D7-186F0584036A
85D3A9ED-4043-464C-BD0B-5C42B153FFFF
862943030994956
863e90b72b41bb4d
866790042479575
87F333FA-24D6-4C3E-BF24-C6077AD918CD
88B15068-426D-4CF7-8527-0CD270336F40
8996FA6D-6FDA-4327-9E19-E62CB3C9245C
8C5AF9BA-9EDF-49DC-B9C8-B087705B229
9404C400-9618-47CF-B18E-807CF2DE2D36
9564BE26-8538-4ED7-936D-DC72E8B2E9E5
9843FFDD-06FE-4D92-91E8-2923F28E5150
9C5CBE41-D39D-4C8D-9D5B-E4D29EE87FC9
9F7C124B-DCDC-4275-9DBB-EB1B82B87B6C
A342D055-A133-4ED8-9297-3E842E5D14EB
A3A0B961-9A1E-4E59-A176-5F89D80167C5
A3B1A252-0485-4F03-8C18-60D6D3EA6EC4
A93E1361-0A8B-47BB-B621-BF6CF5B8804E
ab9ba6038566e179
ADCE303C-8591-4443-ABB7-8DD971F1AF38
B0F3DDD0-65D3-44D3-A7FD-D4AE01C0C53D
B20B9F93-223A-4F75-870F-EC3C30538B7A
B3449179-5317-4BBB-8984-32C7EFDE346B
B41EE248-5ADB-438C-B32A-ACA2736E2DA4
B50E2AD4-A028-4C58-8D9B-8780ED07C62B
B5CE6981-F95A-4557-89F3-C79C528FBD73
B6B43ABF-DE68-43BD-9BD0-EF79948348D2
B7863EF4-5895-478F-ADFC-784A51B1E0DA
BA9FDF53-B45C-4242-95FC-9B34F4C7C0E0
BD04FD4C-95EA-49A0-88C0-C8426EA26723
C4E72CE7-DB5B-48FD-AD9E-60A8A0C9AE77
c5018b29e83cc827
C5A6C7E6-9CB3-4390-B646-010A95BB3E35
C7AC5005-A427-4607-BC8D-6B4739DF989C
C82CD72F-B6F4-4498-99A0-8410DBD600DF
CB406395-1BC6-4E0A-9672-7C0D663C049E
CE0FE271-6CCE-43A3-9024-D4B41A86445E
CF2D1C2A-E701-4832-85CB-6D6E262BB432
D20D4B66-2519-429C-88AB-0B5A6D610DAE
D4D1E8BA-FEB7-471C-83EF-1D34FFAA0E22
D56758BA-ABD1-466D-A08B-98225E57563D
d5a107af92942e7b
D8B1F07E-1449-42C9-AEE1-E70C807FC99C
D936809C-1B26-494F-A069-78DCD5270203
db4bc242e1ededbd
DE6A0082-8248-410E-AA02-C2D9D6110850
DF144876-89F2-449F-85B3-ACA75562EFC6
E06DF90C-4797-4BED-ACFB-160C940A7A7B
e283be27da2765b3
E517CA3D-F564-41FE-808D-DBC987127607
E5589F86-DFD6-4A0E-92AE-E758ABC2D44C
e68b73ae3178ba15
E6F28D0A-088E-43FD-A8B6-D42AFF4932C2
E6FE6EE6-500E-4D9D-9D5B-F5D48960C12C
eb9071780d368b99
F20867DE-9546-47AF-8572-B3F5BD0A676C
F31A891A-79E1-442C-9418-27CADD84C68C
F3EBF79A-EFAE-4D14-81F3-0FBBAF080BBD
f40ba68beb811765fcb5c64448939aaf
F44F4439-9D43-4269-A2DF-68B49F0F1733
F573A31E-4042-41DE-BB45-660E728866A2
F9E16E8F-821D-44E1-BC09-1B0ED1E79DD8
FAE03E68-86E8-4CB7-8AD1-ECF46985F05F
FBB522B5-D575-499C-B2D5-16623AA68C72
FC158A9F-24F9-4C21-BDD5-980613E1589D
FD0CF5F0-0F77-42CE-9EC9-ED8BDC9BD1A7
FDD98AF3-D067-4DF5-8F4B-E2EB68EEC821
FE192742-C292-4FEA-88DD-46EFDAE0D00E
fef98f21fec9b893
FFC49167-39CC-40D2-AE19-04BCAD9D4653
FFD412D3-D88A-4E83-9904-69F8DB940F71
"""

random_udids2 = """
592ff83fbea59035
7B577CC4-E1C2-49EC-9AC3-E62BC9B7A72E
6EB416A2-A837-4140-B1EE-9BE4C8C84709
532D5A76-8162-4AEB-9E5C-A9BDDD040B6B
3ABF36C5-45C6-402B-A7ED-4988E76D1F8B
126B522B-4629-4654-90CD-B27BAAE32BC5
68D08436-AB0E-46FA-ABD7-5CA87662F242
406A7432-AD24-4E87-B315-81B1788978EC
38DF5726-73EA-4DE3-84AE-1D2A2BA92DFD
7D72223C-C9A7-48B8-960B-6984E01BF4E9
4671046D-86E1-4E0E-A81C-7AA03255BE13
7B269E64-85D4-4435-AE56-96A7E4DA94E2
66B100A0-19F2-480D-9A8C-1B454C2F4707
22301ac15bff7923
43CED35C-617A-4F22-AB93-1734AEFBABBD
382221DB-F6ED-44E7-9F56-02DC01B58406
07c0042f0a4a077f
0E07F4E6-7D30-4DCA-AC69-1D6EF5C2E325
3874870A-D580-4F99-9D41-A24D34319075
0FC1EF6D-599C-4619-8AD3-6F7CF6C6E683
38205D8C-7F3F-4203-A93A-B3F1776CE93B
27E91E4D-A117-4D67-BD04-E7956011D9DA
472F893D-3043-469B-8630-7646B6B7C8F6
347627EC-9834-4206-8489-5A1377B4FF53
7242CE59-6F7C-4AAF-9B67-8330DA2AB25F
0EB7EA48-083E-4D6D-B5EF-FD195176C809
0431D275-C465-46CA-9C0F-2E3B4EAC6FE0
01761BB4-4BA4-4D84-A7DD-4AB17281328F
030ED433-7AF2-40F4-9A33-DD681D902D64
640FFFF2-386F-4A0F-8E81-85C4E19E46C6
479C862B-5702-4EC2-B717-7A7C6AAA9D63
13F031CD-DD9B-494D-BDB5-078735E59ED3
07EDBFD5-C8A9-4464-B120-9095A007DC8F
40DB3964-549E-462B-9F41-D5768C111180
435C8FF9-0C77-4F94-9912-92F5624ED1DE
69E54C8E-4396-46D4-838D-D37097393590
2784DA7F-40B9-459E-9EA4-4ECA1A58B34F
3F92314B-36DB-4B3A-B737-CDB05A649844
5819121E-5B31-45DA-8382-AD31A001B75F
0B1A527C-C9E7-4CEA-A0F3-BFAFF84E09F6
22790d264d47d754
34E040A2-7304-40EF-A565-F3159FC8A669
666574F3-07FD-44E3-A844-E964C605E065
2ACB5168-2E95-4C77-A44D-60E5F4D96368
528C60D3-F636-4A2E-80EA-F73238860CA1
114D6CD7-F16B-4C2C-BFF3-E45A88D5640D
1AD7A312-350F-4765-9340-DE1DC25ED5E1
02C8B4F1-4061-4DE7-9C18-10D46B22CF0F
0EEE5FE2-8B46-4ADF-AA06-E44AABBE9B43
7F23B0F3-2850-459F-83C5-533D45DD0225
33470deadc429c95
661DC587-7381-48C3-9FB1-1BD89F5DCBFB
5EF26904-BA69-40B2-B912-0CED16C3E80B
5587D35B-9C73-4D3E-8694-051E0CAF83A9
2A4DF681-3399-49AA-8365-34E7B626D611
71FBBE3B-22B0-46DF-A277-2BBFC8734B80
16841842fb5f558f
6CA3F1A8-7DDF-4899-BFCA-B93050E0CC07
435A05ED-53E0-4DC6-B55D-2360DCD17C48
1DDEB8F5-FA50-4ED4-91FC-31C0B2B27F65
6AA04E14-6A29-4990-B1DB-BA5DB5F44322
"""

import json

import requests

from util import file_util, csv_util

cache = {}
cate_name_cache = {}

user_deal_read_file = '/tmp/user_deal_read.txt'  # 用户近3月内的有效阅读
recon_deal_ids = '/tmp/recon_deal_ids.txt'  # 用户推荐内容
deal_cate_lv1 = '/tmp/deal_cate_lv1.txt'  # 折扣一级分类缓存
cate_name_file = '/tmp/cate_info.txt'  # 分类名字缓存

recon_file_lv1 = '/tmp/推荐内容一级分类百分比.txt'  # 用户推荐内容分类百分比
read_file_lv1 = '/tmp/近3个月内有效阅读一级分类百分比.txt'  # 用户有效阅读分类百分比
# csv中，分类的顺序
title = ['udid', '姓名', '折扣总数',
		 '美妆护肤', '服饰手袋', '电子电脑', '家居厨卫', '个护保健', '母婴儿童', '运动户外',
		 '美食', '旅游', '男士专区', '影视/演出/体育', '金融', '美国生活百科', '资讯', '其他', '美国畅销榜', '黑五',
		 '汽车', 'DealMoon活动']
categories = title[3:len(title)]
# 推荐和有效阅读分类百分比对比图
all_percent_file = '/tmp/折扣一级分类百分比.csv'


def all_udids():
	all_udids = set()
	for x in random_udids.split("\n"):
		if not x: continue
		all_udids.add(x)
	for x in eval_udids.split("\n"):
		if not x: continue
		all_udids.add(x)

	return all_udids


def deal_cate_with_cache(deal_ids: list) -> dict:
	"""
	查折扣的分类信息
	"""
	result, missing = {}, []
	# 从本地获取数据

	if len(cache) == 0: init_cache()

	for deal_id in deal_ids:
		if deal_id not in cache:
			missing.append(deal_id)
		else:
			result[deal_id] = cache[deal_id]

	if len(missing) == 0:
		return result

	print('未命中', missing)
	d = get_deal_cate_from_remote(missing)
	for k in d:
		v = d[k]
		result[k], cache[k] = v, v
		write_to_file(k, v)

	to_del = []
	for k, v in result.items():
		if v == 0:
			to_del.append(k)
	for k in to_del: del result[k]

	return result


def write_to_file(k, v):
	print("写入", k, v)
	with open(deal_cate_lv1, 'a') as f:
		f.write(str(k) + ":" + str(v) + "\n")


def init_cache():
	d = {}

	def func(line):
		splt = line.split(":")
		d[int(splt[0])] = json.loads(splt[1].replace("\n", ""))

	file_util.read_file(deal_cate_lv1, func)

	global cache
	cache = d
	print(cache)


def init_cate_name_cache():
	d = {}

	def func(line):
		splt = line.split(":")
		d[int(splt[0])] = splt[1].replace("\n", "")

	file_util.read_file(cate_name_file, func)

	global cate_name_cache
	cate_name_cache = d
	print(cate_name_cache)


def get_deal_cate_from_remote(missing: list) -> dict:
	"""
	调微服务获取折扣信息
	"""
	url = 'https://ws.dealmoon.com/deal/admin/deal/v1/cms/deal-basic-list'
	params = {
		'isAdState': False
	}
	result = {}
	for i in range(0, len(missing), 20):
		sub_ids = [str(iddd) for iddd in missing[i:i + 20]]
		params['dealIds'] = ",".join(sub_ids)
		resp = requests.get(url=url, params=params)
		resp = resp.json()
		if not resp.get('data'):
			print('no data', params['dealIds'])
			continue
		for x in resp.get('data'):
			deal_id, cate_ids = x['id'], []
			if x.get('categoryInfoList'):
				for cate in x.get('categoryInfoList'):
					cate_id = cate['parentId'] if cate['parentId'] != 0 else cate['id']
					if cate_id == 0: print('分类id是0', deal_id)
					cate_ids.append(cate_id)
				result[deal_id] = cate_ids
	for mis in missing:
		result.setdefault(mis, 0)

	return result


def cate_percent(ids: list) -> dict:
	'''
	统计分类占比
	'''

	stats, total = {}, 0

	deal_cate_dict = deal_cate_with_cache(ids)
	for deal_id in ids:
		if not deal_cate_dict.get(deal_id): continue
		total += 1
		# 这个折扣个分类id
		cate_list: list = deal_cate_dict.get(deal_id)
		cate_set = set()
		for cate in cate_list: cate_set.add(cate)
		for cate in cate_set:
			stats.setdefault(cate, 0)
			stats[cate] += 1

	r = {}
	for cate in stats:
		cate_name = cate_name_cache[cate]
		r[cate_name] = str(round(stats[cate] / total * 100, 2)) + '%'
	return r


def recon_deals_from_server(udid: str) -> list:
	'''
	获取用户推荐内容
	'''
	recons = []
	url = 'https://ws.dealmoon.com/recommend-service/admin/recommend/v1/recommendations'
	params = {'resType': 'deal', 'udid': udid}
	resp = requests.get(url=url, params=params)
	resp = resp.json()
	for x in resp.get('data'):
		recons.append(x['id'])
	return recons


def save_to_file(path: str, js: dict):
	dmp = json.dumps(js, ensure_ascii=False)
	with open(path, 'a') as f:
		f.write(dmp + "\n")
	print(dmp)


def cal_recon_percent_lv1():
	"""
	计算推荐内容的一级分类数据
	"""
	all_recons = get_recons()
	for udid in all_udids():
		# 获取推荐id
		recons = all_recons[udid]
		# 计算各分类的百分比
		percent = cate_percent(recons)
		# 结果写入本地文件
		save_to_file(recon_file_lv1, {'udid': udid, 'percent': percent})


def get_recons():
	d = {}

	def func(line):
		splts = line.split(":")
		udid = splts[0]
		deal_ids = json.loads(splts[1])
		d[udid] = deal_ids

	file_util.read_file(recon_deal_ids, func)

	return d


def cal_read_percent_lv1():
	"""
	计算有效阅读的一级分类数据
	"""
	user_deal_ids = get_read_ids()
	for udid, deal_ids in user_deal_ids.items():
		percent = cate_percent(deal_ids)
		save_to_file(read_file_lv1, {'udid': udid, 'percent': percent})


def get_read_ids():
	"""
	提取用户有效阅读的数据
	:return {
				udid: [dealId1, dealId2]
			}
	"""
	user_deal_ids = {}

	def func(line):
		if line.__contains__('+'): return
		if line.__contains__('temp_deal_read.udid'): return

		splts = line.split('|')
		if splts[2].__contains__('NULL'): return

		udid = splts[1].strip()
		deal_id = int(splts[2].strip())
		user_deal_ids.setdefault(udid, [])
		user_deal_ids.get(udid).append(deal_id)

	file_util.read_file(user_deal_read_file, func)

	return user_deal_ids


def cal_all_cates():
	"""
	计算出所有的分类顺序
	"""
	cate_list = []
	s = set()

	def func(line):
		info = json.loads(line)
		info = info['percent']
		for k in info: s.add(k)

	file_util.read_file(recon_file_lv1, func)
	file_util.read_file(read_file_lv1, func)
	for x in s: cate_list.append(x)
	print(cate_list)


def raw_to_csv():
	"""
	返回本地文件中的数据
	:return:
	"""
	recon_dict, read_dict = {}, {}

	def recon_func(line):
		info = json.loads(line)
		recon_dict[info['udid']] = info['percent']

	def read_func(line):
		info = json.loads(line)
		read_dict[info['udid']] = info['percent']

	file_util.read_file(recon_file_lv1, recon_func)
	file_util.read_file(read_file_lv1, read_func)

	print(recon_dict)
	print(read_dict)
	return recon_dict, read_dict


def write_to_csv():
	recon_dict, read_dict = raw_to_csv()

	num = 10
	for udid in read_dict:
		read_list, recon_list, diff_list = cal_diff(udid, recon_dict.get(udid), read_dict.get(udid))
		csv_util.append_lines(all_percent_file, [read_list, recon_list, diff_list])
		num -= 1
		if num == 0: break


def cal_diff(udid: str, recon_info: dict, read_info: dict):
	read_list, recon_list, diff_list = [udid, '有效阅读'], ['', '推荐内容'], ['', '(推荐-有效)/有效']
	for category in categories:
		reconVal = recon_info.get(category) if recon_info.get(category) else "0%"
		readVal = read_info.get(category) if read_info.get(category) else "0%"
		reconVal, readVal = float(reconVal.replace("%", "")), float(readVal.replace("%", ""))

		if reconVal == 0 and readVal == 0:
			read_list.append("")
			recon_list.append("")
			diff_list.append("")
		else:
			read_list.append(str(readVal) + "%")
			recon_list.append(str(reconVal) + "%")
			diff = (reconVal - readVal) / readVal if readVal != 0 else 1
			diff = round(diff * 100, 2)
			diff_list.append(str(diff) + "%")
	return read_list, recon_list, diff_list


def save_read_data():
	# 用户有效阅读数据
	read_dict: dict = get_read_ids()
	# 评测后台用户数据
	eval_user: dict = {}

	def func(line):
		info = json.loads(line)
		udid, name = info.get('udid'), info.get('name')
		eval_user[udid] = name

	file_util.read_file('/tmp/eval_user.txt', func)

	path = '/tmp/有效阅读.csv'
	data_list = []
	for udid in read_dict:
		user_name = eval_user.get(udid)  # 用户名
		deal_ids = read_dict.get(udid)  # 有效阅读折扣id
		percent = cate_percent(deal_ids)  # 有效阅读分类百分比
		data_list.append(build_data(udid, user_name, len(deal_ids), percent))

	print(len(data_list))
	csv_util.cover(path, title, data_list)


def save_recon_data():
	# 用户有效阅读数据
	read_ids = get_read_ids()
	# 推荐内容数据
	recon_dict: dict = get_recons()
	# 评测后台用户数据
	eval_user: dict = {}

	def func(line):
		info = json.loads(line)
		udid, name = info.get('udid'), info.get('name')
		eval_user[udid] = name

	file_util.read_file('/tmp/eval_user.txt', func)

	path = '/tmp/推荐内容.csv'

	data_list = []
	for udid in recon_dict:
		if udid not in read_ids: continue
		user_name = eval_user.get(udid)  # 用户名
		deal_ids = recon_dict.get(udid)  # 有效阅读折扣id
		percent = cate_percent(deal_ids)  # 有效阅读分类百分比
		data_list.append(build_data(udid, user_name, len(deal_ids), percent))

	print(len(data_list))
	csv_util.cover(path, title, data_list)


def build_data(udid: str, user_name: str, total: int, num_dict: dict):
	"""
	:param udid:
	:param user_name:
	:param total: 	折扣总数
	:param num_dict: 分类对应的数量
		{
			分类名:1
		}
	:return:
	"""
	data = {
		"udid": udid,
		"姓名": user_name,
		"折扣总数": total
	}
	for category in categories:
		percent = num_dict.get(category) if num_dict.get(category) else ""
		data[category] = percent

	return data


# 初始化缓存
init_cache()
init_cate_name_cache()

if __name__ == '__main__':
	save_read_data()
	save_recon_data()
